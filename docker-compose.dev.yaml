services:
  db:
    container_name: mindforge_db
    restart: on-failure
    image: 'postgres:18'
    env_file:
      - .env
    ports:
      - '5432:5432'
    volumes:
      - mindforge_db:/var/lib/postgresql

  # BullMQ Redis instance for local development
  redis:
    image: 'redis:8.4-rc1-alpine'
    container_name: mindforge_redis_dev
    restart: on-failure
    ports:
      - '6379:6379' # Expose Redis port to host for local debugging if needed
    volumes:
      - mindforge_redis_data:/data

  # BullMQ worker for processing background jobs
  worker:
    image: rotour/mindforge-worker:dev
    build:
      context: .
      dockerfile: ./dev/Dockerfile
    container_name: mindforge_worker_dev
    restart: on-failure
    volumes:
      - .:/app
    env_file:
      - .env
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    command: >
      bun run --watch src/lib/server/jobs/worker.ts

volumes:
  mindforge_redis_data:
  mindforge_db:
